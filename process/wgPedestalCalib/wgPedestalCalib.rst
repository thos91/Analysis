=============
wgPedestalCalib
=============

The wgPedestalCalibSummay program has many uses. It can create the
`pedestal_card.xml` file and can produce many plots about the SPIROC2D
pedestal. Before running this program you need to run the wgDecoder,
wgMakeHist, wgAnaHist and wgAnaHistSummary programs in that exact
order. This program needs as an input the xml files produced by the
wgPedestalCalib program.

Arguments
=========

- ``[-h]`` : prints an help message
- ``[-f]`` : input directory with xml files to read (mandatory)
- ``[-o]`` : output directory for the xml summary files (default: same as input directory)
- ``[-i]`` : output directory for plots and images (default: WAGASCI_IMGDIR)
- ``[-n]`` : number of DIFs (default is 2)\n"
- ``[-x]`` : number of chips per DIF (default is 20)
- ``[-y]`` : number of channels per chip (default is 36)

Extrapolated pedestal
=====================

In all the SPIROC chips, the charge ADC count when there is no hit show a small
drift with respect to the actual pedestal. I was told by St√©phane Callier that
the charge_nohit value is affected by a coupling due to the fact that all
channels without hit switch from Track to Hold at the same time but he doesn't
understand exactly why. He noticed that when an external trigger signal is used,
then the pedestal value is more accurate (barely shifted).

For this reason we calculate/extrapolate the pedestal value from the 1 p.e. and
2 p.e. peaks using the following very simple formula:

.. math::

   \textrm{gain} = \textrm{2 p.e. peak} - \textrm{1 p.e. peak}

.. math::
   
   \textrm{nominal pedestal} = \textrm{1 p.e. peak} - \text{gain}

This is done for each chip, channel and column.

pedestal_card.xmlfile
=====================

The pedestal_card.xml file contains every piece of information regarding the SPIROC2D pedestal.
The pedestal is calculated for each chip, channel and column.

.. code-block:: xml
   
   <?xml version="1.0" encoding="UTF-8"?>
   <data>
    <n_difs>2</n_difs>
    <n_chips>20</n_chips>
    <n_chans>32</n_chans>
    <dif_1>
        <chip_0>
            <ch_0>
                <pe1_0>450</pe1_0>
                <pe1_1>450</pe1_1>
                ...
                <pe2_0>500</pe2_0>
                <pe2_1>500</pe2_1>
                ...
                <gain_0>40</gain_0>
                <gain_1>40</gain_1>
                ...
                <ped_0>400</ped_0>
                <ped_1>400</ped_1>
                ...
                <ped_nohit_0>400</ped_nohit_0>
                <ped_nohit_1>400</ped_nohit_1>
            </ch_0>
            <ch_1>
            ...
        </chip_0>
    <dif_1>
   </data>

- ``pe1`` : 1 p.e. peak position
- ``pe2`` : 2 p.e. peak position
- ``gain`` : gain calculated as ``pe2 - pe1``
- ``ped``  : nominal pedestal (see previous section)
- ``ped_nohit`` : measured pedestal (``charge_nohit``)
  
Plots
=====

TO-DO

C API
=====

.. code-block:: cpp

                int PedestalCalib(const char * inputDir,
                                  const char * outputXMLDir,
                                  const char * outputIMGDir,
                                  unsigned n_difs = NDIFS,
                                  unsigned n_chips = NCHIPS,
                                  unsigned n_chans = NCHANNELS);

- ``inputDir``       : complete path to the directory containing the XML files
  generated by the wgAnaHist program (at least mode 12).
- ``outputXMLDir``   : output directory where all the summery XML files are written
- ``outputIMGDir``   : output directory for the PNG graphs
- ``n_difs``         : number of DIFs
- ``n_chips``        : number of chips for each DIF
- ``n_channels``     : number of channels for each chip
